name: Generate TypeScript Types from OpenAPI Schemas

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'services/**/*.py'
      - 'services/**/models/**/*.py'
      - 'services/**/schemas/**/*.py'
      - 'services/**/api/**/*.py'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'services/**/*.py'
      - 'services/**/models/**/*.py'
      - 'services/**/schemas/**/*.py'
      - 'services/**/api/**/*.py'
  workflow_dispatch:
    inputs:
      service:
        description: 'Specific service to regenerate types for (optional)'
        required: false
        default: 'all'

jobs:
  generate-types:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better diff detection
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Install frontend dependencies
      working-directory: frontend
      run: npm ci
    
    - name: Generate OpenAPI schemas
      run: |
        echo "Generating OpenAPI schemas for all services..."
        ./scripts/generate-openapi-schemas.sh
        
        echo "Generated schemas:"
        find . -name "*.json" -path "*/openapi/*" | head -20
    
    - name: Generate TypeScript types
      working-directory: frontend
      run: |
        echo "Generating TypeScript types from OpenAPI schemas..."
        
        # Use our new type generation script
        cd ..
        ./scripts/update-types.sh
        
        echo "Type generation complete!"
    
    - name: Validate generated types
      working-directory: frontend
      run: |
        echo "Validating generated types..."
        
        # Run type validation
        cd ..
        if ! ./scripts/validate-types.sh; then
          echo "‚ùå Type validation failed"
          exit 1
        fi
        
        echo "‚úÖ Type validation passed"
    
    - name: Run type integration tests
      working-directory: frontend
      run: |
        echo "Running type integration tests..."
        
        # Run integration tests
        cd ..
        if ! ./scripts/validate-types.sh --integration; then
          echo "‚ùå Type integration tests failed"
          exit 1
        fi
        
        echo "‚úÖ Type integration tests passed"
    
    - name: Check for type generation changes
      id: check-changes
      run: |
        if git diff --quiet frontend/types/; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "No type changes detected"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Type changes detected:"
          git diff --name-only frontend/types/
        fi
    
    - name: Commit type changes
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add frontend/types/
        git commit -m "Auto-generate TypeScript types from OpenAPI schemas
        
        Generated from backend schema changes in:
        $(git log --oneline -10 --grep="Merge\|commit" | head -5 | sed 's/^/- /')
        
        [skip ci]"
    
    - name: Push type changes
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        git push origin HEAD:${{ github.ref }}
    
    - name: Create PR for type changes
      if: steps.check-changes.outputs.changes == 'true' && github.event_name == 'push'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        title: "ü§ñ Auto-generate TypeScript types from OpenAPI schemas"
        body: |
          This PR contains automatically generated TypeScript types from backend OpenAPI schema changes.
          
          ## Changes
          - Regenerated TypeScript types for all services
          - Updated type definitions to match latest backend schemas
          
          ## Generated From
          Backend schema changes in:
          $(git log --oneline -10 --grep="Merge\|commit" | head -5 | sed 's/^/- /')
          
          ## Review
          - [ ] Types compile without errors
          - [ ] No breaking changes introduced
          - [ ] All services covered
          
          Auto-generated by GitHub Actions workflow.
        branch: auto-types-update-${{ github.sha }}
        delete-branch: true
        labels: |
          auto-generated
          types
          openapi
        assignees: ${{ github.actor }}
    
    - name: Notify on failure
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: |
          ‚ùå Type generation failed for ${{ github.repository }}
          
          Workflow: ${{ github.workflow }}
          Run: ${{ github.run_id }}
          Commit: ${{ github.sha }}
          
          Check the logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    
    - name: Notify on success
      if: success() && steps.check-changes.outputs.changes == 'true'
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: |
          ‚úÖ TypeScript types generated successfully for ${{ github.repository }}
          
          Changes detected and committed automatically.
          Check the generated types: ${{ github.server_url }}/${{ github.repository }}/tree/${{ github.sha }}/frontend/types
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
